"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.devServerIndexHtml = exports.indexHtml = void 0;
const fs_1 = require("fs");
const glob = require("glob");
const variables_reducer_1 = require("./variables-reducer");
function indexHtml(outputDir, locales = [], raw, ssr = false, runtime = false) {
    try {
        glob.sync(`${outputDir}/browser/**/index.html`).forEach((filePath) => {
            const html = (0, fs_1.readFileSync)(filePath, "utf-8");
            const content = (0, variables_reducer_1.variablesReducer)(html, raw);
            try {
                (0, fs_1.writeFileSync)(filePath, runtime
                    ? content.replace(/<head>/, `<head><script src="/ngx-env.js"></script>`)
                    : content);
            }
            catch (e) {
                console.log(`❌ Failed to replace variables in ${filePath} ❌`);
                throw e;
            }
        });
        if (ssr) {
            glob
                .sync(`${outputDir}/server/**/index.server.html`)
                .forEach((filePath) => {
                const html = (0, fs_1.readFileSync)(filePath, "utf-8");
                const content = (0, variables_reducer_1.variablesReducer)(html, raw);
                try {
                    (0, fs_1.writeFileSync)(filePath, content);
                }
                catch (e) {
                    console.log(`❌ Failed to replace variables in ${filePath} ❌`);
                    throw e;
                }
            });
        }
        if (runtime) {
            const runtimeStmt = `globalThis._NGX_ENV_ = ${JSON.stringify(raw, null, 2)};`;
            if (locales.length > 0) {
                locales.forEach((locale) => {
                    (0, fs_1.writeFileSync)(`${outputDir}/browser/${locale}/ngx-env.js`, runtimeStmt);
                });
            }
            else {
                (0, fs_1.writeFileSync)(`${outputDir}/browser/ngx-env.js`, runtimeStmt);
            }
        }
    }
    catch (e) {
        console.error(e);
    }
}
exports.indexHtml = indexHtml;
function devServerIndexHtml(content, raw, runtime = false) {
    const html = (0, variables_reducer_1.variablesReducer)(content, raw);
    return runtime
        ? html.replace(/<head>/, `<head><script>globalThis._NGX_ENV_ = ${JSON.stringify(raw)}</script>`)
        : html;
}
exports.devServerIndexHtml = devServerIndexHtml;
